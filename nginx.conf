user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'cache:$upstream_cache_status';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Cache settings
    proxy_cache_path /var/cache/nginx/apk levels=1:2 keys_zone=apk_cache:10m max_size=10g inactive=365d use_temp_path=off;

    # DNS resolver (using Docker's DNS server and Google DNS as fallback)
    resolver 127.0.0.11 8.8.8.8 valid=300s;
    resolver_timeout 10s;

    server {
        listen 80;
        server_name _;

        # Cache configuration
        proxy_cache apk_cache;
        proxy_cache_valid 200 365d;
        proxy_cache_valid 404 1h;
        proxy_cache_lock on;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;

        # Add cache status header
        add_header X-Cache-Status $upstream_cache_status;

        # Proxy settings
        proxy_pass_request_headers on;
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;

        # Cache everything under /alpine/
        location ~ ^/alpine/(.*)$ {
            proxy_pass https://dl-cdn.alpinelinux.org/alpine/$1$is_args$args;
            proxy_cache_key "$scheme$proxy_host$request_uri";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # Root location with instructions
        location = / {
            return 200 "APK Repository Cache\n\nUsage: Configure your Alpine system to use this cache:\n\nAdd to /etc/apk/repositories:\nhttp://YOUR_CACHE_SERVER/alpine/v3.18/main\nhttp://YOUR_CACHE_SERVER/alpine/v3.18/community\n\nReplace YOUR_CACHE_SERVER with this server's address and v3.18 with your Alpine version.\n";
            add_header Content-Type text/plain;
        }
    }
}
